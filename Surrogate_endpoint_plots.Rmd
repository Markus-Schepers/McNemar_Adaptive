---
title: "McNemar Adaptive Design — Surrogate endpoint plots"
output: html_document
---

```{r setup, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(warning=FALSE,message=FALSE,fig.path = "figs/")

set.seed(1)

library(dplyr)
library(ggplot2)
library(tidyr)
library(knitr)

source("Conditional-Power-McNemar.R")

```


# Scenario 1


```{r scenario1setup}
target_power <- 0.8
alpha <- 0.05

psi <- 0.2
nd1_surr <- 8
n1 <- 38
n2 <- 38
```


```{r scenario1, echo=FALSE}
p_grid <- seq(0.5, 1.0, by = 0.05)

theta_grid <- expand.grid(
  theta1 = c(1.0,0.95,0.9,0.85),
  theta0 = c(0,0.05, 0.10, 0.15)
)

power_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    cp_final <- conditional_power(
      p_star = p_star,
      nd1 = nd1_surr,
      nsecond = n2,
      psi = psi,
      alpha = alpha
    )
    
    cp_surr <- predicted_power_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      nsecond = n2,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      cp_final = cp_final,
      cp_surrogate = cp_surr,
      diff = cp_surr - cp_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
power_df$theta1 <- factor(power_df$theta1, levels = rev(sort(unique(power_df$theta1))))
power_df$theta0 <- factor(power_df$theta0, levels = sort(unique(power_df$theta0)))

## --- plots: conditional power ------------------------------------------

ggplot(power_df, aes(x = p_star)) +
  geom_line(aes(y = cp_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = cp_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = "Conditional power",x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(power_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = "Surrogate − Final conditional power",
    x = expression(p["*"])
  ) +
  theme_minimal()

## --- summary table ------------------------------------------------------

#power_df |>
#  group_by(theta1, theta0) |>
#  summarise(
#    max_abs_diff = max(abs(diff), na.rm = TRUE),
#    mean_diff = mean(diff, na.rm = TRUE),
#    sd_diff = sd(diff, na.rm = TRUE),
#    .groups = "drop"
#  )

## --- sample size comparison --------------------------------------------

n2_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    n2_final <- min_nsecond(
      p = p_star,
      nd1 = nd1_surr,
      target_power = target_power,
      psi = psi,
      alpha = alpha
    )
    
    n2_surr <- min_nsecond_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      target_power = target_power,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      n2_final = n2_final,
      n2_surrogate = n2_surr,
      diff = n2_surr - n2_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
n2_df$theta1 <- factor(n2_df$theta1, levels = rev(sort(unique(n2_df$theta1))))
n2_df$theta0 <- factor(n2_df$theta0, levels = sort(unique(n2_df$theta0)))

## --- plots: sample size -------------------------------------------------

ggplot(n2_df, aes(x = p_star)) +
  geom_line(aes(y = n2_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = n2_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = expression(n[2]), x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(n2_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = expression(n[2]^" surrogate − final"),
    x = expression(p["*"])
  ) +
  theme_minimal()

```



# Scenario 2


```{r scenario2setup}
target_power <- 0.8
alpha <- 0.05

psi <- 0.2
nd1_surr <- 4
n1 <- 38
n2 <- 38
```


```{r scenario2, echo=FALSE}
p_grid <- seq(0.5, 1.0, by = 0.05)

theta_grid <- expand.grid(
  theta1 = c(1.0,0.95,0.9,0.85),
  theta0 = c(0,0.05, 0.10, 0.15)
)

power_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    cp_final <- conditional_power(
      p_star = p_star,
      nd1 = nd1_surr,
      nsecond = n2,
      psi = psi,
      alpha = alpha
    )
    
    cp_surr <- predicted_power_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      nsecond = n2,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      cp_final = cp_final,
      cp_surrogate = cp_surr,
      diff = cp_surr - cp_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
power_df$theta1 <- factor(power_df$theta1, levels = rev(sort(unique(power_df$theta1))))
power_df$theta0 <- factor(power_df$theta0, levels = sort(unique(power_df$theta0)))

## --- plots: conditional power ------------------------------------------

ggplot(power_df, aes(x = p_star)) +
  geom_line(aes(y = cp_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = cp_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = "Conditional power",x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(power_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = "Surrogate − Final conditional power",
    x = expression(p["*"])
  ) +
  theme_minimal()

## --- summary table ------------------------------------------------------

#power_df |>
#  group_by(theta1, theta0) |>
#  summarise(
#    max_abs_diff = max(abs(diff), na.rm = TRUE),
#    mean_diff = mean(diff, na.rm = TRUE),
#    sd_diff = sd(diff, na.rm = TRUE),
#    .groups = "drop"
#  )

## --- sample size comparison --------------------------------------------

n2_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    n2_final <- min_nsecond(
      p = p_star,
      nd1 = nd1_surr,
      target_power = target_power,
      psi = psi,
      alpha = alpha
    )
    
    n2_surr <- min_nsecond_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      target_power = target_power,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      n2_final = n2_final,
      n2_surrogate = n2_surr,
      diff = n2_surr - n2_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
n2_df$theta1 <- factor(n2_df$theta1, levels = rev(sort(unique(n2_df$theta1))))
n2_df$theta0 <- factor(n2_df$theta0, levels = sort(unique(n2_df$theta0)))

## --- plots: sample size -------------------------------------------------

ggplot(n2_df, aes(x = p_star)) +
  geom_line(aes(y = n2_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = n2_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = expression(n[2]), x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(n2_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = expression(n[2]^" surrogate − final"),
    x = expression(p["*"])
  ) +
  theme_minimal()

```


# Scenario 3


```{r scenario3setup}
target_power <- 0.8
alpha <- 0.05

psi <- 0.25
nd1_surr <- 8
n1 <- 38
n2 <- 38
```


```{r scenario3, echo=FALSE}
p_grid <- seq(0.5, 1.0, by = 0.05)

theta_grid <- expand.grid(
  theta1 = c(1.0,0.95,0.9,0.85),
  theta0 = c(0,0.05, 0.10, 0.15)
)

power_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    cp_final <- conditional_power(
      p_star = p_star,
      nd1 = nd1_surr,
      nsecond = n2,
      psi = psi,
      alpha = alpha
    )
    
    cp_surr <- predicted_power_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      nsecond = n2,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      cp_final = cp_final,
      cp_surrogate = cp_surr,
      diff = cp_surr - cp_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
power_df$theta1 <- factor(power_df$theta1, levels = rev(sort(unique(power_df$theta1))))
power_df$theta0 <- factor(power_df$theta0, levels = sort(unique(power_df$theta0)))

## --- plots: conditional power ------------------------------------------

ggplot(power_df, aes(x = p_star)) +
  geom_line(aes(y = cp_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = cp_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = "Conditional power",x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(power_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = "Surrogate − Final conditional power",
    x = expression(p["*"])
  ) +
  theme_minimal()

## --- summary table ------------------------------------------------------

#power_df |>
#  group_by(theta1, theta0) |>
#  summarise(
#    max_abs_diff = max(abs(diff), na.rm = TRUE),
#    mean_diff = mean(diff, na.rm = TRUE),
#    sd_diff = sd(diff, na.rm = TRUE),
#    .groups = "drop"
#  )

## --- sample size comparison --------------------------------------------

n2_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    n2_final <- min_nsecond(
      p = p_star,
      nd1 = nd1_surr,
      target_power = target_power,
      psi = psi,
      alpha = alpha
    )
    
    n2_surr <- min_nsecond_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      target_power = target_power,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      n2_final = n2_final,
      n2_surrogate = n2_surr,
      diff = n2_surr - n2_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
n2_df$theta1 <- factor(n2_df$theta1, levels = rev(sort(unique(n2_df$theta1))))
n2_df$theta0 <- factor(n2_df$theta0, levels = sort(unique(n2_df$theta0)))

## --- plots: sample size -------------------------------------------------

ggplot(n2_df, aes(x = p_star)) +
  geom_line(aes(y = n2_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = n2_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = expression(n[2]), x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(n2_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = expression(n[2]^" surrogate − final"),
    x = expression(p["*"])
  ) +
  theme_minimal()

```




# Scenario 4


```{r scenario4setup}
target_power <- 0.8
alpha <- 0.05

psi <- 0.6
nd1_surr <- 8
n1 <- 38
n2 <- 38
```


```{r scenario4, echo=FALSE}
p_grid <- seq(0.5, 1.0, by = 0.05)

theta_grid <- expand.grid(
  theta1 = c(1.0,0.95,0.9,0.85),
  theta0 = c(0,0.05, 0.10, 0.15)
)

power_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    cp_final <- conditional_power(
      p_star = p_star,
      nd1 = nd1_surr,
      nsecond = n2,
      psi = psi,
      alpha = alpha
    )
    
    cp_surr <- predicted_power_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      nsecond = n2,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      cp_final = cp_final,
      cp_surrogate = cp_surr,
      diff = cp_surr - cp_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
power_df$theta1 <- factor(power_df$theta1, levels = rev(sort(unique(power_df$theta1))))
power_df$theta0 <- factor(power_df$theta0, levels = sort(unique(power_df$theta0)))

## --- plots: conditional power ------------------------------------------

ggplot(power_df, aes(x = p_star)) +
  geom_line(aes(y = cp_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = cp_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = "Conditional power",x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(power_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = "Surrogate − Final conditional power",
    x = expression(p["*"])
  ) +
  theme_minimal()

## --- summary table ------------------------------------------------------

#power_df |>
#  group_by(theta1, theta0) |>
#  summarise(
#    max_abs_diff = max(abs(diff), na.rm = TRUE),
#    mean_diff = mean(diff, na.rm = TRUE),
#    sd_diff = sd(diff, na.rm = TRUE),
#    .groups = "drop"
#  )

## --- sample size comparison --------------------------------------------

n2_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    n2_final <- min_nsecond(
      p = p_star,
      nd1 = nd1_surr,
      target_power = target_power,
      psi = psi,
      alpha = alpha
    )
    
    n2_surr <- min_nsecond_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      target_power = target_power,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      n2_final = n2_final,
      n2_surrogate = n2_surr,
      diff = n2_surr - n2_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
n2_df$theta1 <- factor(n2_df$theta1, levels = rev(sort(unique(n2_df$theta1))))
n2_df$theta0 <- factor(n2_df$theta0, levels = sort(unique(n2_df$theta0)))

## --- plots: sample size -------------------------------------------------

ggplot(n2_df, aes(x = p_star)) +
  geom_line(aes(y = n2_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = n2_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = expression(n[2]), x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(n2_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = expression(n[2]^" surrogate − final"),
    x = expression(p["*"])
  ) +
  theme_minimal()

```

# Scenario 5


```{r scenario5setup}
target_power <- 0.8
alpha <- 0.05

psi <- 0.6
nd1_surr <- 24
n1 <- 38
n2 <- 38
```


```{r scenario5, echo=FALSE}
p_grid <- seq(0.5, 1.0, by = 0.05)

theta_grid <- expand.grid(
  theta1 = c(1.0,0.95,0.9,0.85),
  theta0 = c(0,0.05, 0.10, 0.15)
)

power_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    cp_final <- conditional_power(
      p_star = p_star,
      nd1 = nd1_surr,
      nsecond = n2,
      psi = psi,
      alpha = alpha
    )
    
    cp_surr <- predicted_power_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      nsecond = n2,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      cp_final = cp_final,
      cp_surrogate = cp_surr,
      diff = cp_surr - cp_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
power_df$theta1 <- factor(power_df$theta1, levels = rev(sort(unique(power_df$theta1))))
power_df$theta0 <- factor(power_df$theta0, levels = sort(unique(power_df$theta0)))

## --- plots: conditional power ------------------------------------------

ggplot(power_df, aes(x = p_star)) +
  geom_line(aes(y = cp_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = cp_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = "Conditional power",x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(power_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = "Surrogate − Final conditional power",
    x = expression(p["*"])
  ) +
  theme_minimal()

## --- summary table ------------------------------------------------------

#power_df |>
#  group_by(theta1, theta0) |>
#  summarise(
#    max_abs_diff = max(abs(diff), na.rm = TRUE),
#    mean_diff = mean(diff, na.rm = TRUE),
#    sd_diff = sd(diff, na.rm = TRUE),
#    .groups = "drop"
#  )

## --- sample size comparison --------------------------------------------

n2_df <- lapply(seq_len(nrow(theta_grid)), function(i) {
  
  th1 <- theta_grid$theta1[i]
  th0 <- theta_grid$theta0[i]
  
  df <- lapply(p_grid, function(p_star) {
    
    n2_final <- min_nsecond(
      p = p_star,
      nd1 = nd1_surr,
      target_power = target_power,
      psi = psi,
      alpha = alpha
    )
    
    n2_surr <- min_nsecond_surrogate(
      p_star = p_star,
      nd1_surr = nd1_surr,
      n1 = n1,
      theta1 = th1,
      theta0 = th0,
      psi = psi,
      target_power = target_power,
      alpha = alpha
    )
    
    data.frame(
      p_star = p_star,
      n2_final = n2_final,
      n2_surrogate = n2_surr,
      diff = n2_surr - n2_final,
      theta1 = th1,
      theta0 = th0
    )
  }) |> bind_rows()
  
  df
}) |> bind_rows()
n2_df$theta1 <- factor(n2_df$theta1, levels = rev(sort(unique(n2_df$theta1))))
n2_df$theta0 <- factor(n2_df$theta0, levels = sort(unique(n2_df$theta0)))

## --- plots: sample size -------------------------------------------------

ggplot(n2_df, aes(x = p_star)) +
  geom_line(aes(y = n2_final, colour = "Final"), linewidth = 1) +
  geom_line(aes(y = n2_surrogate, colour = "Surrogate"),
            linewidth = 1, linetype = "dashed") +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(y = expression(n[2]), x = expression(p["*"]), colour = "") +
  theme_minimal()

ggplot(n2_df, aes(x = p_star, y = diff)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_line(linewidth = 1) +
  facet_grid(theta1 ~ theta0,
             labeller = labeller(
               theta1 = function(x) paste0("θ[1] == ", as.numeric(as.character(x))),
               theta0 = function(x) paste0("θ[0] == ", as.numeric(as.character(x)))
             , .default = label_parsed)) +
  labs(
    y = expression(n[2]^" surrogate − final"),
    x = expression(p["*"])
  ) +
  theme_minimal()

```

